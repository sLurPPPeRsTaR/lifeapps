"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DdRumErrorTracking = void 0;

var _InternalLog = require("../../InternalLog");

var _SdkVerbosity = require("../../SdkVerbosity");

var _errorUtils = require("../../errorUtils");

var _DdRum = require("../DdRum");

var _types = require("../types");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Provides RUM auto-instrumentation feature to track errors as RUM events.
 */
class DdRumErrorTracking {
  // eslint-disable-next-line
  // eslint-disable-next-line

  /**
   * Starts tracking errors and sends a RUM Error event every time an error is detected.
   */
  static startTracking() {
    // extra safety to avoid wrapping the Error handler twice
    if (DdRumErrorTracking.isTracking) {
      _InternalLog.InternalLog.log('Datadog SDK is already tracking errors', _SdkVerbosity.SdkVerbosity.WARN);

      return;
    }

    if (ErrorUtils) {
      DdRumErrorTracking.defaultErrorHandler = ErrorUtils.getGlobalHandler();
      DdRumErrorTracking.defaultConsoleError = console.error;
      ErrorUtils.setGlobalHandler(DdRumErrorTracking.onGlobalError);
      console.error = DdRumErrorTracking.onConsoleError;
      DdRumErrorTracking.isTracking = true;

      _InternalLog.InternalLog.log('Datadog SDK is tracking errors', _SdkVerbosity.SdkVerbosity.INFO);
    } else {
      _InternalLog.InternalLog.log('Datadog SDK cannot track errors, ErrorUtils is not defined', _SdkVerbosity.SdkVerbosity.ERROR);
    }
  } // eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types


  static onGlobalError(error, isFatal) {
    const message = (0, _errorUtils.getErrorMessage)(error);
    const stacktrace = (0, _errorUtils.getErrorStackTrace)(error);

    _DdRum.DdRum.addError(message, _types.ErrorSource.SOURCE, stacktrace, {
      '_dd.error.is_crash': isFatal,
      '_dd.error.raw': error
    }).then(() => {
      DdRumErrorTracking.isInDefaultErrorHandler = true;

      try {
        DdRumErrorTracking.defaultErrorHandler(error, isFatal);
      } finally {
        DdRumErrorTracking.isInDefaultErrorHandler = false;
      }
    });
  }

  static onConsoleError(...params) {
    if (DdRumErrorTracking.isInDefaultErrorHandler) {
      return;
    }

    let stack = _errorUtils.EMPTY_STACK_TRACE;

    for (let i = 0; i < params.length; i += 1) {
      const param = params[i];
      const paramStack = (0, _errorUtils.getErrorStackTrace)(param);

      if (paramStack !== _errorUtils.EMPTY_STACK_TRACE) {
        stack = paramStack;
        break;
      }
    }

    const message = params.map(param => {
      if (typeof param === 'string') {
        return param;
      } else {
        return (0, _errorUtils.getErrorMessage)(param);
      }
    }).join(' ');

    _DdRum.DdRum.addError(message, _types.ErrorSource.CONSOLE, stack).then(() => {
      DdRumErrorTracking.defaultConsoleError.apply(console, params);
    });
  }

}

exports.DdRumErrorTracking = DdRumErrorTracking;

_defineProperty(DdRumErrorTracking, "isTracking", false);

_defineProperty(DdRumErrorTracking, "isInDefaultErrorHandler", false);

_defineProperty(DdRumErrorTracking, "defaultErrorHandler", (_error, _isFatal) => {});

_defineProperty(DdRumErrorTracking, "defaultConsoleError", (..._params) => {});
//# sourceMappingURL=DdRumErrorTracking.js.map