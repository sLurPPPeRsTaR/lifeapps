{"version":3,"sources":["DdRumErrorTracking.tsx"],"names":["DdRumErrorTracking","startTracking","isTracking","InternalLog","log","SdkVerbosity","WARN","ErrorUtils","defaultErrorHandler","getGlobalHandler","defaultConsoleError","console","error","setGlobalHandler","onGlobalError","onConsoleError","INFO","ERROR","isFatal","message","stacktrace","DdRum","addError","ErrorSource","SOURCE","then","isInDefaultErrorHandler","params","stack","EMPTY_STACK_TRACE","i","length","param","paramStack","map","join","CONSOLE","apply","_error","_isFatal","_params"],"mappings":"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","sourcesContent":["/*\n * Unless explicitly stated otherwise all files in this repository are licensed under the Apache License Version 2.0.\n * This product includes software developed at Datadog (https://www.datadoghq.com/).\n * Copyright 2016-Present Datadog, Inc.\n */\n\nimport type { ErrorHandlerCallback } from 'react-native';\n\nimport { InternalLog } from '../../InternalLog';\nimport { SdkVerbosity } from '../../SdkVerbosity';\nimport {\n    getErrorMessage,\n    getErrorStackTrace,\n    EMPTY_STACK_TRACE\n} from '../../errorUtils';\nimport { DdRum } from '../DdRum';\nimport { ErrorSource } from '../types';\n\n/**\n * Provides RUM auto-instrumentation feature to track errors as RUM events.\n */\nexport class DdRumErrorTracking {\n    private static isTracking = false;\n\n    private static isInDefaultErrorHandler = false;\n\n    // eslint-disable-next-line\n    private static defaultErrorHandler: ErrorHandlerCallback = (_error: any, _isFatal?: boolean) => { }\n\n    // eslint-disable-next-line\n    private static defaultConsoleError = (..._params: unknown[]) => { }\n\n    /**\n     * Starts tracking errors and sends a RUM Error event every time an error is detected.\n     */\n    static startTracking(): void {\n        // extra safety to avoid wrapping the Error handler twice\n        if (DdRumErrorTracking.isTracking) {\n            InternalLog.log(\n                'Datadog SDK is already tracking errors',\n                SdkVerbosity.WARN\n            );\n            return;\n        }\n\n        if (ErrorUtils) {\n            DdRumErrorTracking.defaultErrorHandler = ErrorUtils.getGlobalHandler();\n            DdRumErrorTracking.defaultConsoleError = console.error;\n\n            ErrorUtils.setGlobalHandler(DdRumErrorTracking.onGlobalError);\n            console.error = DdRumErrorTracking.onConsoleError;\n\n            DdRumErrorTracking.isTracking = true;\n            InternalLog.log(\n                'Datadog SDK is tracking errors',\n                SdkVerbosity.INFO\n            );\n        } else {\n            InternalLog.log(\n                'Datadog SDK cannot track errors, ErrorUtils is not defined',\n                SdkVerbosity.ERROR\n            );\n        }\n    }\n\n    // eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types\n    static onGlobalError(error: any, isFatal?: boolean): void {\n        const message = getErrorMessage(error);\n        const stacktrace = getErrorStackTrace(error);\n        DdRum.addError(message, ErrorSource.SOURCE, stacktrace, {\n            '_dd.error.is_crash': isFatal,\n            '_dd.error.raw': error\n        }).then(() => {\n            DdRumErrorTracking.isInDefaultErrorHandler = true;\n            try {\n                DdRumErrorTracking.defaultErrorHandler(error, isFatal);\n            } finally {\n                DdRumErrorTracking.isInDefaultErrorHandler = false;\n            }\n        });\n    }\n\n    static onConsoleError(...params: unknown[]): void {\n        if (DdRumErrorTracking.isInDefaultErrorHandler) {\n            return;\n        }\n\n        let stack: string = EMPTY_STACK_TRACE;\n        for (let i = 0; i < params.length; i += 1) {\n            const param = params[i];\n            const paramStack = getErrorStackTrace(param);\n            if (paramStack !== EMPTY_STACK_TRACE) {\n                stack = paramStack;\n                break;\n            }\n        }\n\n        const message = params\n            .map(param => {\n                if (typeof param === 'string') {\n                    return param;\n                } else {\n                    return getErrorMessage(param);\n                }\n            })\n            .join(' ');\n\n        DdRum.addError(message, ErrorSource.CONSOLE, stack).then(() => {\n            DdRumErrorTracking.defaultConsoleError.apply(console, params);\n        });\n    }\n}\n"]}